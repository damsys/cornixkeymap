<div class="keymap-viewer">
  <div class="layer-tabs">
    @for (layer of layers; track layer.index) {
      <button
        type="button"
        class="tab"
        [class.active]="activeLayerIndex() === layer.index"
        (click)="setLayer(layer.index)"
      >
        Layer {{ layer.index }}
      </button>
    }
  </div>

  <div class="keyboard-wrap">
    <app-keyboard-svg [layer]="activeLayer" [compact]="false" />
  </div>

  @if (hasEncoders && encodersForActiveLayer().length > 0) {
    <div class="encoders-section">
      <h3 class="section-title">エンコーダー</h3>
      @for (enc of encodersForActiveLayer(); track enc.layer + '-' + enc.encoderIndex) {
        <div class="encoder-row">
          <span class="encoder-label">Enc {{ enc.encoderIndex }}</span>
          <span class="encoder-ccw">↺ {{ getKeycodeLabel(enc.counterClockwise) }}</span>
          <span class="encoder-cw">↻ {{ getKeycodeLabel(enc.clockwise) }}</span>
        </div>
      }
    </div>
  }

  @if (macros.length > 0) {
    <div class="section">
      <h3 class="section-title">マクロ</h3>
      <div class="macro-grid">
        @for (mac of macros; track mac.index) {
          <div class="macro-card">
            <div class="macro-header">M{{ mac.index }}</div>
            <div class="macro-actions">
              @for (action of mac.actions; track $index) {
                <span class="macro-action">
                  {{ action.type }}:
                  @for (k of action.keys; track k) {
                    <span class="key-badge">{{ getKeycodeLabel(k) }}</span>
                  }
                </span>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }

  @if (tapDances.length > 0) {
    <div class="section">
      <h3 class="section-title">タップダンス</h3>
      <div class="tapdance-grid">
        @for (td of tapDances; track td.index) {
          <div class="tapdance-card">
            <div class="tapdance-header">TD{{ td.index }} ({{ td.tappingTerm }}ms)</div>
            <div class="tapdance-actions">
              @if (td.tap && td.tap !== 'KC_NO') {
                <span class="tapdance-item">Tap: {{ getKeycodeLabel(td.tap) }}</span>
              }
              @if (td.hold && td.hold !== 'KC_NO') {
                <span class="tapdance-item">Hold: {{ getKeycodeLabel(td.hold) }}</span>
              }
              @if (td.doubleTap && td.doubleTap !== 'KC_NO') {
                <span class="tapdance-item">2Tap: {{ getKeycodeLabel(td.doubleTap) }}</span>
              }
              @if (td.tapHold && td.tapHold !== 'KC_NO') {
                <span class="tapdance-item">Tap+Hold: {{ getKeycodeLabel(td.tapHold) }}</span>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
